{% extends "base.html" %}

{% block title %}NBA Game Predictions{% endblock %}

{% block content %}
    <!-- Filters Section -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
    <section class="filters">
        <div class="filter-item date-filter">
            <label for="date">Date:</label>
            <div class="date-filter-row">
                <div class="date-wrapper">
                    <input type="date" id="date" value="{{ current_date }}">
                </div>
                <div class="week-view-container">
                    <div class="week-nav" id="prev-week">
                        <i class="fas fa-chevron-left">←</i>
                    </div>
                    <div class="week-days">
                        <!-- Week days will be populated by JavaScript -->
                    </div>
                    <div class="week-nav" id="next-week">
                        <i class="fas fa-chevron-right">→</i>
                    </div>
                </div>
            </div>
        </div>
        <div class="filter-item">
            <label for="team">Team:</label>
            <select id="team">
                <option value="all">All Teams</option>
                <!-- Teams populated by JavaScript -->
            </select>
        </div>
    </section>
    
    <!-- Games Section -->
    <section class="games-container">
        <div class="games-header">
            <h2>Today's Games (<span id="displayed-date">{{ current_date | date_format }}</span>)</h2>
            <div class="games-counter">Loading...</div>
        </div>
        
        <div class="games-grid">
            <!-- Game cards populated by JavaScript -->
            <div class="loading">Loading games...</div>
        </div>
    </section>

    <!-- Load date-selector.js first -->
    <script src="{{ url_for('static', filename='js/date-selector.js') }}"></script>
    <!-- Load the new gameData.js file -->
    <script src="{{ url_for('static', filename='js/gameData.js') }}"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize
            const teamSelect = document.getElementById('team');
            const gamesGrid = document.querySelector('.games-grid');
            const gamesCounter = document.querySelector('.games-counter');
            
            // Populate teams dropdown with fetched data
            gameDataManager.on('onTeamsLoaded', nbaTeams => {
                nbaTeams.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team.abbreviation;
                    option.textContent = team.full_name;
                    teamSelect.appendChild(option);
                });
            });
            
            // Handle when games are loaded
            gameDataManager.on('onGamesLoaded', games => {
                gamesGrid.innerHTML = '';
                
                if (games.length === 0) {
                    gamesGrid.innerHTML = '<div class="no-games">No games scheduled for this date.</div>';
                    gamesCounter.textContent = '0 games';
                    return;
                }
                
                // Update games counter
                gamesCounter.textContent = `${games.length} game${games.length !== 1 ? 's' : ''}`;
                
                // Create and append game cards
                games.forEach(game => {
                    const gameCard = gameDataManager.createGameCard(game);
                    gamesGrid.appendChild(gameCard);
                });
                
                // Load team logos after adding game cards to DOM
                gameDataManager.loadTeamLogos();
                
                // Apply filters after games are loaded
                applyFilters();
            });
            
            // Function to apply filters
            function applyFilters() {
                const selectedTeam = teamSelect.value;
                const gameCards = document.querySelectorAll('.game-card');
                
                gameDataManager.filterGamesByTeam(selectedTeam, gameCards, gamesCounter, gamesGrid);
            }
            
            // Event listeners for automatic updates
            teamSelect.addEventListener('change', applyFilters);
            
            // Function to load games for a specific date
            function loadGamesForDate(date) {
                gamesGrid.innerHTML = '<div class="loading">Loading games...</div>';
                gameDataManager.fetchGames(date);
            }
            
            // Expose function to global scope for date-selector.js to use
            window.fetchGames = loadGamesForDate;
            
            // Initialize
            gameDataManager.fetchTeams();
            loadGamesForDate(document.getElementById('date').value);
        });
    </script>
{% endblock %}